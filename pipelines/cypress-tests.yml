steps:
  - download: ToDosDemoClient
    artifact: cypress
    displayName: 'Download client app artifacts'

  - task: ExtractFiles@1
    displayName: 'Extract tests files'
    inputs:
      archiveFilePatterns: '$(Pipeline.Workspace)/ToDosDemoClient/cypress/cypress*.zip'
      destinationFolder: 'cypress'
      
  task: eliostruyf.build-task.custom-build-task.file-creator@5
    displayName: 'Create package.json file'
    inputs:
      fileoverwrite: true
      filepath: 'package.json'
      filecontent: |
        {
          "cypress-cucumber-preprocessor": {
            "nonGlobalStepDefinitions": false,
            "stepDefinitions": "cypress/cypress/integration/step-definitions"
          },
          "dependencies": {
            "@cypress/webpack-preprocessor": "^4.1.3",
            "cypress": "^4.2.0",
            "cypress-cucumber-preprocessor": "^2.0.1",
            "ts-loader": "^6.2.1",
            "typescript": "3.4.5",
            "webpack": "^4.42.0"
          },
        }
      endWithNewLine: true

  - task: eliostruyf.build-task.custom-build-task.file-creator@5
    displayName: 'Create cypress config file'
    inputs:
      fileoverwrite: true
      filepath: 'cypress.json'
      filecontent: |
        {
          "testFiles": "**/*.feature",
          "env":
          {
              "RETRIES": 3
          },
          "integrationFolder": "cypress/cypress/integration",
          "projectId": "u3uuhi",
          "baseUrl": "https://demo.todos.kros.wtf",
          "chromeWebSecurity": false,
          "ProjectName": "Demo.BestPractices",
          "OAuthUrl": "https://login.kros.wtf",
          "OAuthClientId": "Demo.BestPractices.Postman",
          "OAuthUsername": "integrationtests@kros.sk",
          "OAuthPassword": "integrationtests",
          "UserEmail": "integrationtests@kros.sk",
          "UserName": "Integration Tests",
          "reporter": "junit",
          "reporterOptions": {
            "mochaFile": "cypress/cypress/test-output-[hash].xml",
            "toConsole": true,
            "attachments": true
            },
            "video": false,
            "pluginsFile": "cypress/cypress/plugins/index.js",
            "supportFile": "cypress/cypress/support/index.js"
        }
      endWithNewLine: true
      
  - task: Npm@1
    displayName: 'npm install'

  - script: 'npx cypress run --record --key f6df6669-db0d-4228-9368-242987f124b9'
    displayName: 'Run tests with Cypress'
    continueOnError: true
    timeoutInMinutes: 10

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      mergeTestResults: true
      testRunTitle: 'Cypress Test Results'
      testResultsFiles: 'cypress/cypress/test-output*.xml'
