parameters:
  microservices: []

steps:
- ${{ each microservice in parameters.microservices }}: # Each microservice
  - task: PowerShell@2
    displayName: "Prepare connection string: ${{microservice}}"
    inputs:
      filePath: '$(Pipeline.Workspace)/ToDosDemoServices/drop/pipelines/Prepare-ConnectionString.ps1'
      arguments: -microserviceName '${{microservice}}'
    env:
      CONNECTIONSTRING_TEMPLATE: $(ConnectionStringTemplate)
  - task: FileTransform@1
    displayName: 'Transform variables: ${{microservice}}'
    inputs:
      folderPath: '$(Pipeline.Workspace)/ToDosDemoServices/drop/Kros.${{microservice}}.Api.zip'
      fileType: json
      targetFiles: '**/*.json'
  - task: AzureWebApp@1
    displayName: 'Microservice Deploy: ${{microservice}}'
    inputs:
      azureSubscription: $(azureSubscriptionName)
      appName: 'kros-demo-${{microservice}}-api'
      package: '$(Pipeline.Workspace)/ToDosDemoServices/drop/Kros.${{microservice}}.Api.zip'
